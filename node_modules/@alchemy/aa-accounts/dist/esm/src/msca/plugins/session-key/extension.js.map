{"version":3,"file":"extension.js","sourceRoot":"","sources":["../../../../../../src/msca/plugins/session-key/extension.ts"],"names":[],"mappings":"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","sourcesContent":["import type {\n  GetEntryPointFromAccount,\n  UserOperationOverridesParameter,\n} from \"@alchemy/aa-core\";\nimport {\n  AccountNotFoundError,\n  type GetAccountParameter,\n  type IsUndefined,\n  type SendUserOperationResult,\n  type SmartContractAccount,\n  type UserOperationOverrides,\n} from \"@alchemy/aa-core\";\nimport type { Address, Chain, Client, Hex, Transport } from \"viem\";\nimport type { GetPluginAddressParameter } from \"../types.js\";\nimport {\n  SessionKeyPlugin,\n  sessionKeyPluginActions as sessionKeyPluginActions_,\n  type SessionKeyPluginActions as SessionKeyPluginActions_,\n} from \"./plugin.js\";\nimport { buildSessionKeysToRemoveStruct } from \"./utils.js\";\n\nexport type SessionKeyPluginActions<\n  TAccount extends SmartContractAccount | undefined =\n    | SmartContractAccount\n    | undefined,\n  TEntryPointVersion extends GetEntryPointFromAccount<TAccount> = GetEntryPointFromAccount<TAccount>\n> = Omit<\n  SessionKeyPluginActions_<TAccount>,\n  | \"removeSessionKey\"\n  | \"addSessionKey\"\n  | \"rotateSessionKey\"\n  | \"updateKeyPermissions\"\n> & {\n  isAccountSessionKey: (\n    args: { key: Address } & GetPluginAddressParameter &\n      GetAccountParameter<TAccount>\n  ) => Promise<boolean>;\n\n  getAccountSessionKeys: (\n    args: GetPluginAddressParameter & GetAccountParameter<TAccount>\n  ) => Promise<ReadonlyArray<Address>>;\n\n  removeSessionKey: (\n    args: { key: Address } & GetPluginAddressParameter &\n      GetAccountParameter<TAccount> &\n      UserOperationOverridesParameter<TEntryPointVersion>\n  ) => Promise<SendUserOperationResult<TEntryPointVersion>>;\n\n  addSessionKey: (\n    args: {\n      key: Address;\n      permissions: Hex[];\n      tag: Hex;\n    } & GetPluginAddressParameter &\n      GetAccountParameter<TAccount> &\n      UserOperationOverridesParameter<TEntryPointVersion>\n  ) => Promise<SendUserOperationResult<TEntryPointVersion>>;\n\n  rotateSessionKey: (\n    args: {\n      oldKey: Address;\n      newKey: Address;\n    } & GetPluginAddressParameter &\n      GetAccountParameter<TAccount> &\n      UserOperationOverridesParameter<TEntryPointVersion>\n  ) => Promise<SendUserOperationResult<TEntryPointVersion>>;\n\n  updateSessionKeyPermissions: (\n    args: {\n      key: Address;\n      permissions: Hex[];\n    } & GetPluginAddressParameter &\n      GetAccountParameter<TAccount> &\n      UserOperationOverridesParameter<TEntryPointVersion>\n  ) => Promise<SendUserOperationResult<TEntryPointVersion>>;\n} & (IsUndefined<TAccount> extends false\n    ? {\n        getAccountSessionKeys: (\n          args?: GetPluginAddressParameter & GetAccountParameter<TAccount>\n        ) => Promise<ReadonlyArray<Address>>;\n      }\n    : {});\n\nexport const sessionKeyPluginActions: <\n  TTransport extends Transport = Transport,\n  TChain extends Chain | undefined = Chain | undefined,\n  TAccount extends SmartContractAccount | undefined =\n    | SmartContractAccount\n    | undefined\n>(\n  client: Client<TTransport, TChain, TAccount>\n) => SessionKeyPluginActions<TAccount> = <\n  TTransport extends Transport = Transport,\n  TChain extends Chain | undefined = Chain | undefined,\n  TAccount extends SmartContractAccount | undefined =\n    | SmartContractAccount\n    | undefined,\n  TEntryPointVersion extends GetEntryPointFromAccount<TAccount> = GetEntryPointFromAccount<TAccount>\n>(\n  client: Client<TTransport, TChain, TAccount>\n) => {\n  const {\n    removeSessionKey,\n    addSessionKey,\n    rotateSessionKey,\n    updateKeyPermissions,\n    ...og\n  } = sessionKeyPluginActions_<TTransport, TChain, TAccount>(client);\n\n  return {\n    ...og,\n    isAccountSessionKey: async ({\n      key,\n      pluginAddress,\n      account = client.account,\n    }) => {\n      if (!account) throw new AccountNotFoundError();\n\n      const contract = SessionKeyPlugin.getContract(client, pluginAddress);\n\n      return await contract.read.isSessionKeyOf([account.address, key]);\n    },\n\n    getAccountSessionKeys: async (\n      args: GetPluginAddressParameter & GetAccountParameter<TAccount>\n    ) => {\n      const account = args?.account ?? client.account;\n      if (!account) throw new AccountNotFoundError();\n\n      const contract = SessionKeyPlugin.getContract(\n        client,\n        args?.pluginAddress\n      );\n\n      return await contract.read.sessionKeysOf([account.address]);\n    },\n\n    removeSessionKey: async ({\n      key,\n      overrides,\n      account = client.account,\n      pluginAddress,\n    }) => {\n      if (!account) throw new AccountNotFoundError();\n\n      const sessionKeysToRemove = await buildSessionKeysToRemoveStruct(client, {\n        keys: [key],\n        account,\n        pluginAddress,\n      });\n\n      return removeSessionKey({\n        args: [key, sessionKeysToRemove[0].predecessor],\n        overrides: overrides as UserOperationOverrides<TEntryPointVersion>,\n        account,\n      });\n    },\n\n    addSessionKey: async ({\n      key,\n      tag,\n      permissions,\n      overrides,\n      pluginAddress,\n      account = client.account,\n    }) => {\n      if (!account) throw new AccountNotFoundError();\n\n      return addSessionKey({\n        args: [key, tag, permissions],\n        overrides: overrides as UserOperationOverrides<TEntryPointVersion>,\n        account,\n        pluginAddress,\n      });\n    },\n\n    rotateSessionKey: async ({\n      newKey,\n      oldKey,\n      overrides,\n      pluginAddress,\n      account = client.account,\n    }) => {\n      if (!account) throw new AccountNotFoundError();\n\n      const contract = SessionKeyPlugin.getContract(client, pluginAddress);\n\n      const predecessor = await contract.read.findPredecessor([\n        account.address,\n        oldKey,\n      ]);\n\n      return rotateSessionKey({\n        args: [oldKey, predecessor, newKey],\n        overrides: overrides as UserOperationOverrides<TEntryPointVersion>,\n        account,\n        pluginAddress,\n      });\n    },\n\n    updateSessionKeyPermissions: async ({\n      key,\n      permissions,\n      overrides,\n      pluginAddress,\n      account = client.account,\n    }) => {\n      if (!account) throw new AccountNotFoundError();\n\n      return updateKeyPermissions({\n        args: [key, permissions],\n        overrides: overrides as UserOperationOverrides<\n          GetEntryPointFromAccount<TAccount>\n        >,\n        account,\n        pluginAddress,\n      });\n    },\n  };\n};\n"]}