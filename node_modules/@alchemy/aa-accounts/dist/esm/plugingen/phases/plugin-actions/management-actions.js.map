{"version":3,"file":"management-actions.js","sourceRoot":"","sources":["../../../../../plugingen/phases/plugin-actions/management-actions.ts"],"names":[],"mappings":"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","sourcesContent":["import { kebabCase } from \"change-case\";\nimport dedent from \"dedent\";\nimport type { PluginGenConfig } from \"../../../plugindefs/types\";\nimport type { Phase, PhaseInput } from \"../../types\";\n\nexport const ManagementActionsGenPhase: Phase = async (input) => {\n  const { addImport, config, contract, addType } = input;\n  if (config.installConfig != null) {\n    addImports(\n      addImport,\n      config.installConfig.dependencies?.map((x) => x.plugin) ?? []\n    );\n\n    const initArgs = config.installConfig.initAbiParams ?? [];\n\n    addType(\"InstallArgs\", JSON.stringify(initArgs));\n    addType(\n      `Install${contract.name}Params`,\n      dedent`{\n        args: Parameters<typeof encodeAbiParameters<InstallArgs>>[1];\n        pluginAddress?: Address;\n        dependencyOverrides?: FunctionReference[];\n    }`,\n      true\n    );\n    addType(\n      `ManagementActions<\n        TAccount extends SmartContractAccount | undefined = SmartContractAccount | undefined,\n        TContext extends UserOperationContext | undefined = UserOperationContext | undefined,\n        TEntryPointVersion extends GetEntryPointFromAccount<TAccount> = GetEntryPointFromAccount<TAccount>\n      >`,\n      dedent`{\n        install${contract.name}: (args: UserOperationOverridesParameter<TEntryPointVersion> &\n          Install${contract.name}Params & GetAccountParameter<TAccount> & GetContextParameter<TContext>) =>\n            Promise<SendUserOperationResult<TEntryPointVersion>>\n      }`\n    );\n\n    const dependencies = (config.installConfig.dependencies ?? []).map(\n      (x) => dedent`\n        (() => {\n          const pluginAddress = ${x.plugin.name}.meta.addresses[chain.id];\n          if (!pluginAddress) {\n            throw new Error(\"missing ${x.plugin.name} address for chain \" + chain.name);\n          }\n\n          return encodePacked(\n            [\"address\", \"uint8\"],\n            [pluginAddress, ${x.functionId}]\n          );\n        })()\n      `\n    );\n\n    const installMethodName = `install${contract.name}`;\n\n    input.content.push(dedent`\n    ${installMethodName}({account = client.account, overrides, context, ...params}) {\n      if (!account) {\n        throw new AccountNotFoundError();\n      }\n\n      if (!isSmartAccountClient(client)) {\n        throw new IncompatibleClientError(\"SmartAccountClient\", \"${installMethodName}\", client);\n      }\n\n      const chain = client.chain;\n      if (!chain) {\n        throw new ChainNotFoundError();\n      }\n\n      const dependencies = params.dependencyOverrides ?? [${dependencies.join(\n        \",\\n\\n\"\n      )}];\n      const pluginAddress = params.pluginAddress ?? ${\n        contract.name\n      }.meta.addresses[chain.id] as Address | undefined;\n\n      if (!pluginAddress) {\n        throw new Error(\"missing ${\n          contract.name\n        } address for chain \" + chain.name);\n      }\n\n      return installPlugin_(client, {\n        pluginAddress,\n        pluginInitData: encodeAbiParameters(${JSON.stringify(\n          initArgs\n        )}, params.args),\n        dependencies,\n        overrides,\n        account,\n        context,\n      });\n    }\n  `);\n  }\n\n  return input;\n};\n\nconst addImports = (\n  addImport: PhaseInput[\"addImport\"],\n  deps?: PluginGenConfig[]\n) => {\n  if (deps != null && deps.length > 0) {\n    addImport(\"viem\", { name: \"encodePacked\" });\n    deps.forEach((x) => {\n      // TODO: after plugingen becomes its own cli tool package, this should be changed to\n      // `addImport(\"@alchemy/aa-accounts\", { name: x.name });`\n      addImport(\n        `../${kebabCase(x.name.replaceAll(/[pP]lugin/g, \"\"))}/plugin.js`,\n        {\n          name: x.name,\n        }\n      );\n    });\n  }\n\n  addImport(\"@alchemy/aa-core\", { name: \"ChainNotFoundError\" });\n  addImport(\"viem\", { name: \"encodeAbiParameters\" });\n  // TODO: after plugingen becomes its own cli tool package, this should be changed to\n  // `addImport(\"@alchemy/aa-accounts\", { name: \"installPlugin as installPlugin_\" });`\n  addImport(\"../../plugin-manager/installPlugin.js\", {\n    name: \"installPlugin as installPlugin_\",\n  });\n  addImport(\"@alchemy/aa-core\", {\n    name: \"GetAccountParameter\",\n    isType: true,\n  });\n  addImport(\"@alchemy/aa-core\", {\n    name: \"GetEntryPointFromAccount\",\n    isType: true,\n  });\n  addImport(\"@alchemy/aa-core\", {\n    name: \"UserOperationContext\",\n    isType: true,\n  });\n  // TODO: after plugingen becomes its own cli tool package, this should be changed to\n  // `addImport(\"@alchemy/aa-accounts\", { name: \"FunctionReference\", isType: true });`\n  addImport(\"../../account-loupe/types.js\", {\n    name: \"FunctionReference\",\n    isType: true,\n  });\n  addImport(\"@alchemy/aa-core\", { name: \"GetContextParameter\", isType: true });\n};\n"]}