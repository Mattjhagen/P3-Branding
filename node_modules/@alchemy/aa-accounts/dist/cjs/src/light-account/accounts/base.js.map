{"version":3,"file":"base.js","sourceRoot":"","sources":["../../../../../src/light-account/accounts/base.ts"],"names":[],"mappings":"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","sourcesContent":["import {\n  FailedToGetStorageSlotError,\n  createBundlerClient,\n  toSmartContractAccount,\n  type Abi,\n  type EntryPointDef,\n  type SmartAccountSigner,\n  type SmartContractAccountWithSigner,\n  type ToSmartContractAccountParams,\n  type UpgradeToAndCallParams,\n} from \"@alchemy/aa-core\";\nimport {\n  concat,\n  encodeFunctionData,\n  fromHex,\n  hashMessage,\n  hashTypedData,\n  trim,\n  type Address,\n  type Chain,\n  type Hex,\n  type SignTypedDataParameters,\n  type Transport,\n} from \"viem\";\nimport type {\n  AccountVersionDef,\n  GetEntryPointForLightAccountVersion,\n  GetLightAccountVersion,\n  LightAccountType,\n  LightAccountVersionDef,\n} from \"../types.js\";\nimport { AccountVersionRegistry } from \"../utils.js\";\n\nenum SignatureType {\n  EOA = \"0x00\",\n  CONTRACT = \"0x01\",\n  CONTRACT_WITH_ADDR = \"0x02\",\n}\n\nexport type LightAccountBase<\n  TSigner extends SmartAccountSigner = SmartAccountSigner,\n  TLightAccountType extends LightAccountType = LightAccountType,\n  TLightAccountVersion extends GetLightAccountVersion<TLightAccountType> = GetLightAccountVersion<TLightAccountType>,\n  TEntryPointVersion extends GetEntryPointForLightAccountVersion<\n    TLightAccountType,\n    TLightAccountVersion\n  > = GetEntryPointForLightAccountVersion<\n    TLightAccountType,\n    TLightAccountVersion\n  >\n> = SmartContractAccountWithSigner<\n  TLightAccountType,\n  TSigner,\n  TEntryPointVersion\n> & {\n  getLightAccountVersion: () => TLightAccountVersion;\n};\n\n//#region CreateLightAccountBaseParams\nexport type CreateLightAccountBaseParams<\n  TTransport extends Transport = Transport,\n  TSigner extends SmartAccountSigner = SmartAccountSigner,\n  TLightAccountType extends LightAccountType = LightAccountType,\n  TLightAccountVersion extends GetLightAccountVersion<TLightAccountType> = GetLightAccountVersion<TLightAccountType>,\n  TEntryPointVersion extends GetEntryPointForLightAccountVersion<\n    TLightAccountType,\n    TLightAccountVersion\n  > = GetEntryPointForLightAccountVersion<\n    TLightAccountType,\n    TLightAccountVersion\n  >\n> = Pick<\n  ToSmartContractAccountParams<\n    TLightAccountType,\n    TTransport,\n    Chain,\n    TEntryPointVersion\n  >,\n  \"transport\" | \"chain\" | \"getAccountInitCode\"\n> & {\n  abi: Abi;\n  signer: TSigner;\n  accountAddress: Address;\n  version: LightAccountVersionDef<TLightAccountType, TLightAccountVersion>;\n  entryPoint: EntryPointDef<TEntryPointVersion, Chain>;\n};\n//#endregion CreateLightAccountBaseParams\n\nexport async function createLightAccountBase<\n  TTransport extends Transport = Transport,\n  TSigner extends SmartAccountSigner = SmartAccountSigner,\n  TLightAccountType extends LightAccountType = LightAccountType,\n  TLightAccountVersion extends GetLightAccountVersion<TLightAccountType> = GetLightAccountVersion<TLightAccountType>,\n  TEntryPointVersion extends GetEntryPointForLightAccountVersion<\n    TLightAccountType,\n    TLightAccountVersion\n  > = GetEntryPointForLightAccountVersion<\n    TLightAccountType,\n    TLightAccountVersion\n  >\n>(\n  config: CreateLightAccountBaseParams<\n    TTransport,\n    TSigner,\n    TLightAccountType,\n    TLightAccountVersion,\n    TEntryPointVersion\n  >\n): Promise<\n  LightAccountBase<\n    TSigner,\n    TLightAccountType,\n    TLightAccountVersion,\n    TEntryPointVersion\n  >\n>;\n\nexport async function createLightAccountBase({\n  transport,\n  chain,\n  signer,\n  abi,\n  version: { version, type },\n  entryPoint,\n  accountAddress,\n  getAccountInitCode,\n}: CreateLightAccountBaseParams): Promise<LightAccountBase> {\n  const client = createBundlerClient({\n    transport,\n    chain,\n  });\n\n  const encodeUpgradeToAndCall = async ({\n    upgradeToAddress,\n    upgradeToInitData,\n  }: UpgradeToAndCallParams): Promise<Hex> => {\n    const storage = await client.getStorageAt({\n      address: accountAddress,\n      // the slot at which impl addresses are stored by UUPS\n      slot: \"0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc\",\n    });\n\n    if (storage == null) {\n      throw new FailedToGetStorageSlotError(\n        \"0x360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc\",\n        \"Proxy Implementation Address\"\n      );\n    }\n\n    const implementationAddresses = Object.values(\n      AccountVersionRegistry[type]\n    ).map((x: AccountVersionDef) => x.address[chain.id].impl);\n\n    // only upgrade undeployed accounts (storage 0) or deployed light accounts, error otherwise\n    if (\n      fromHex(storage, \"number\") !== 0 &&\n      !implementationAddresses.some((x) => x === trim(storage))\n    ) {\n      throw new Error(\n        `could not determine if smart account implementation is ${type} ${version}`\n      );\n    }\n\n    return encodeFunctionData({\n      abi,\n      functionName: \"upgradeToAndCall\",\n      args: [upgradeToAddress, upgradeToInitData],\n    });\n  };\n\n  const signWith1271WrapperV1 = async (hashedMessage: Hex): Promise<Hex> => {\n    return signer.signTypedData({\n      // EIP712Domain(string name,string version,uint256 chainId,address verifyingContract)\n      // https://github.com/alchemyplatform/light-account/blob/main/src/LightAccount.sol#L236\n      domain: {\n        chainId: Number(client.chain.id),\n        name: type,\n        verifyingContract: accountAddress,\n        version: \"1\",\n      },\n      types: {\n        LightAccountMessage: [{ name: \"message\", type: \"bytes\" }],\n      },\n      message: {\n        message: hashedMessage,\n      },\n      primaryType: \"LightAccountMessage\",\n    });\n  };\n\n  const account = await toSmartContractAccount({\n    transport,\n    chain,\n    entryPoint,\n    accountAddress,\n    source: type,\n    getAccountInitCode,\n    encodeExecute: async ({ target, data, value }) => {\n      return encodeFunctionData({\n        abi,\n        functionName: \"execute\",\n        args: [target, value ?? 0n, data],\n      });\n    },\n    encodeBatchExecute: async (txs) => {\n      const [targets, values, datas] = txs.reduce(\n        (accum, curr) => {\n          accum[0].push(curr.target);\n          accum[1].push(curr.value ?? 0n);\n          accum[2].push(curr.data);\n\n          return accum;\n        },\n        [[], [], []] as [Address[], bigint[], Hex[]]\n      );\n      return encodeFunctionData({\n        abi,\n        functionName: \"executeBatch\",\n        args: [targets, values, datas],\n      });\n    },\n    signUserOperationHash: async (uoHash: Hex) => {\n      const signature = await signer.signMessage({ raw: uoHash });\n      switch (version) {\n        case \"v2.0.0\":\n          // TODO: handle case where signer is an SCA.\n          return concat([SignatureType.EOA, signature]);\n        default:\n          return signature;\n      }\n    },\n    async signMessage({ message }) {\n      switch (version as string) {\n        case \"v1.0.1\":\n          return signer.signMessage(message);\n        case \"v1.0.2\":\n          throw new Error(`${type} ${version} doesn't support 1271`);\n        case \"v1.1.0\":\n          return signWith1271WrapperV1(hashMessage(message));\n        case \"v2.0.0\":\n          const signature = await signWith1271WrapperV1(hashMessage(message));\n          // TODO: handle case where signer is an SCA.\n          return concat([SignatureType.EOA, signature]);\n        default:\n          throw new Error(`Unknown version ${type} of ${version}`);\n      }\n    },\n    async signTypedData(params) {\n      switch (version as string) {\n        case \"v1.0.1\":\n          return signer.signTypedData(\n            params as unknown as SignTypedDataParameters\n          );\n        case \"v1.0.2\":\n          throw new Error(\n            `Version ${version} of LightAccount doesn't support 1271`\n          );\n        case \"v1.1.0\":\n          return signWith1271WrapperV1(hashTypedData(params));\n        case \"v2.0.0\":\n          const signature = await signWith1271WrapperV1(hashTypedData(params));\n          // TODO: handle case where signer is an SCA.\n          return concat([SignatureType.EOA, signature]);\n        default:\n          throw new Error(`Unknown version ${version} of LightAccount`);\n      }\n    },\n    getDummySignature: (): Hex => {\n      const signature =\n        \"0xfffffffffffffffffffffffffffffff0000000000000000000000000000000007aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa1c\";\n      switch (version as string) {\n        case \"v1.0.1\":\n        case \"v1.0.2\":\n        case \"v1.1.0\":\n          return signature;\n        case \"v2.0.0\":\n          return concat([SignatureType.EOA, signature]);\n        default:\n          throw new Error(`Unknown version ${type} of ${version}`);\n      }\n    },\n    encodeUpgradeToAndCall,\n  });\n\n  return {\n    ...account,\n    source: type,\n    getLightAccountVersion: () => version,\n    getSigner: () => signer,\n  };\n}\n"]}